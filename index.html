<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Multi-Stream Audio</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #17a2b8;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #1a1a2e;
            color: var(--light-color);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 8px;
            height: 100vh;
            overflow: hidden;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 12px;
            height: calc(100vh - 20px);
        }
        
        .control-panel {
            background-color: var(--dark-color);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .video-container {
            background-color: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .video-player {
            width: 100%;
            height: 100%;
            background-color: #000;
            flex: 1;
            min-height: 0;
            object-fit: contain;
        }

        .video-player.fit-to-page {
            object-fit: cover;
        }

        /* Multi-Stream Layout */
        .multi-stream-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 1000;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 2px;
            padding: 2px;
        }

        .multi-stream-item {
            position: relative;
            background: #111;
            overflow: hidden;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .multi-stream-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: all 0.3s ease;
        }

        .multi-stream-item.fit-to-screen .multi-stream-video {
            object-fit: cover;
        }

        .multi-stream-overlay {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 10px;
            z-index: 2;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
            max-width: calc(100% - 16px);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .multi-stream-controls {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 4px;
            background: rgba(0,0,0,0.9);
            padding: 6px 8px;
            border-radius: 8px;
            z-index: 2;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .multi-stream-item:hover .multi-stream-controls {
            opacity: 1;
        }

        .multi-stream-btn {
            background: var(--secondary-color);
            border: none;
            color: white;
            padding: 4px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 9px;
            transition: all 0.2s ease;
            min-width: 30px;
        }

        .multi-stream-btn:hover {
            background: var(--primary-color);
            transform: translateY(-1px);
        }

        .multi-stream-btn.active {
            background: var(--success-color);
        }

        .multi-stream-btn.danger {
            background: var(--danger-color);
        }

        .multi-stream-btn.warning {
            background: var(--warning-color);
        }

        .exit-multi-stream {
            position: fixed;
            top: 15px;
            right: 15px;
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 1001;
            font-weight: bold;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .exit-multi-stream:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .multi-stream-layout-controls {
            position: fixed;
            top: 15px;
            left: 15px;
            display: flex;
            gap: 8px;
            z-index: 1001;
            flex-wrap: wrap;
            max-width: 300px;
        }

        .layout-btn {
            background: rgba(0,0,0,0.8);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            font-size: 11px;
        }

        .layout-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .layout-btn.active {
            background: var(--success-color);
        }

        .stream-status {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 8px;
            z-index: 2;
            backdrop-filter: blur(5px);
        }

        .status-live {
            background: var(--success-color);
        }

        .status-buffering {
            background: var(--warning-color);
        }

        .status-error {
            background: var(--danger-color);
        }

        .stream-audio-indicator {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 8px;
            z-index: 2;
            backdrop-filter: blur(5px);
        }

        .audio-on {
            background: var(--info-color);
        }

        .audio-off {
            background: #7f8c8d;
        }
        
        .video-controls {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .control-group {
            display: flex;
            gap: 6px;
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 12px;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-multi {
            background: linear-gradient(45deg, #3498db, #9b59b6);
            color: white;
        }
        
        .btn-small {
            padding: 4px 8px;
            font-size: 10px;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .form-group {
            margin-bottom: 10px;
        }
        
        label {
            display: block;
            margin-bottom: 4px;
            font-weight: bold;
            font-size: 12px;
        }
        
        input, select {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #555;
            background-color: #2c3e50;
            color: var(--light-color);
            font-size: 12px;
        }
        
        .section-title {
            margin: 12px 0 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid #555;
            font-size: 14px;
        }
        
        .channel-list-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .channel-list {
            flex: 1;
            overflow-y: auto;
            margin-top: 6px;
            border: 1px solid #444;
            border-radius: 6px;
            background-color: #2c3e50;
        }
        
        .channel-item {
            padding: 8px;
            background-color: #34495e;
            margin-bottom: 3px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
            border-left: 3px solid transparent;
        }
        
        .channel-item:hover {
            background-color: #3d566e;
            border-left-color: var(--secondary-color);
        }
        
        .channel-item.active {
            background-color: var(--secondary-color);
        }

        .channel-item.selected {
            background: linear-gradient(45deg, #34495e, #3498db);
            border: 2px solid var(--secondary-color);
        }
        
        /* MODIFICHE: Ridotta l'altezza del pannello di analisi */
        .debug-panel {
            background-color: #2c3e50;
            border-radius: 12px;
            padding: 8px;
            margin-top: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
            height: 300px; /* Ridotta da 360px a 300px */
            display: flex;
            flex-direction: column;
        }
        
        .debug-panel h3 {
            margin-bottom: 6px;
            font-size: 13px;
        }
        
        .debug-info {
            background-color: #1a1a2e;
            padding: 8px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 11px;
            flex: 1;
            overflow-y: auto;
            line-height: 1.3;
        }
        
        /* MODIFICHE: Container per log e grafici affiancati */
        .analysis-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            height: 100%;
        }
        
        .log-container {
            background-color: #1a1a2e;
            border-radius: 6px;
            padding: 6px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .log-title {
            font-size: 11px;
            margin-bottom: 4px;
            text-align: center;
            color: #aaa;
        }
        
        .graphs-container {
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 8px;
        }
        
        .graph-container {
            background-color: #1a1a2e;
            border-radius: 6px;
            padding: 6px;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .graph-title {
            font-size: 11px;
            margin-bottom: 4px;
            text-align: center;
            color: #aaa;
        }
        
        /* MODIFICHE: Aggiunto valore numerico live */
        .graph-value {
            position: absolute;
            top: 6px;
            right: 6px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: bold;
            z-index: 3;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .graph-value.bitrate {
            color: var(--secondary-color);
        }
        
        .graph-value.buffer {
            color: var(--success-color);
        }
        
        .graph-value.volume {
            color: #9b59b6;
        }
        
        .graph-value.fps {
            color: var(--warning-color);
        }
        
        .graph-value.quality {
            color: #e74c3c;
        }
        
        .graph-value.network {
            color: #1abc9c;
        }
        
        .graph-canvas {
            flex: 1;
            background-color: #0f0f1a;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }
        
        .graph {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .graph-line {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0;
            transition: height 0.5s ease;
        }
        
        .graph-line.bitrate {
            background: linear-gradient(to top, rgba(52, 152, 219, 0.6), rgba(52, 152, 219, 0.2));
        }
        
        .graph-line.buffer {
            background: linear-gradient(to top, rgba(46, 204, 113, 0.6), rgba(46, 204, 113, 0.2));
        }
        
        .graph-line.volume {
            background: linear-gradient(to top, rgba(155, 89, 182, 0.6), rgba(155, 89, 182, 0.2));
        }
        
        .graph-line.fps {
            background: linear-gradient(to top, rgba(241, 196, 15, 0.6), rgba(241, 196, 15, 0.2));
        }
        
        .graph-line.quality {
            background: linear-gradient(to top, rgba(231, 76, 60, 0.6), rgba(231, 76, 60, 0.2));
        }
        
        .graph-line.network {
            background: linear-gradient(to top, rgba(26, 188, 156, 0.6), rgba(26, 188, 156, 0.2));
        }
        
        .graph-point {
            position: absolute;
            width: 3px;
            height: 3px;
            border-radius: 50%;
            transform: translate(-50%, 50%);
            z-index: 2;
        }
        
        .graph-point.bitrate {
            background-color: var(--secondary-color);
        }
        
        .graph-point.buffer {
            background-color: var(--success-color);
        }
        
        .graph-point.volume {
            background-color: #9b59b6;
        }
        
        .graph-point.fps {
            background-color: var(--warning-color);
        }
        
        .graph-point.quality {
            background-color: #e74c3c;
        }
        
        .graph-point.network {
            background-color: #1abc9c;
        }
        
        .graph-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .graph-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            font-size: 8px;
            color: #7f8c8d;
        }
        
        .graph-legend {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 4px;
            font-size: 8px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .legend-color {
            width: 6px;
            height: 6px;
            border-radius: 2px;
        }
        
        .legend-color.bitrate {
            background-color: var(--secondary-color);
        }
        
        .legend-color.buffer {
            background-color: var(--success-color);
        }
        
        .legend-color.volume {
            background-color: #9b59b6;
        }
        
        .legend-color.fps {
            background-color: var(--warning-color);
        }
        
        .legend-color.quality {
            background-color: #e74c3c;
        }
        
        .legend-color.network {
            background-color: #1abc9c;
        }
        
        .status-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 4px;
        }
        
        .status-ok {
            background-color: var(--success-color);
        }
        
        .status-error {
            background-color: var(--danger-color);
        }
        
        .status-warning {
            background-color: var(--warning-color);
        }
        
        .status-info {
            background-color: var(--info-color);
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .volume-slider {
            width: 80px;
        }
        
        .fullscreen-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 5px 10px;
            cursor: pointer;
            z-index: 10;
            font-size: 11px;
            transition: background-color 0.3s;
        }
        
        .fullscreen-btn:hover {
            background-color: rgba(0, 0, 0, 0.9);
        }
        
        .fit-to-page-btn {
            position: absolute;
            top: 8px;
            right: 80px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 5px 10px;
            cursor: pointer;
            z-index: 10;
            font-size: 11px;
            transition: background-color 0.3s;
        }
        
        .fit-to-page-btn:hover {
            background-color: rgba(0, 0, 0, 0.9);
        }
        
        .fit-to-page-btn.active {
            background-color: var(--secondary-color);
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-top: 6px;
        }
        
        .stat-box {
            background-color: #2c3e50;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 14px;
            font-weight: bold;
            margin: 2px 0;
        }
        
        .stat-label {
            font-size: 10px;
            color: #aaa;
        }
        
        .progress-bar {
            height: 4px;
            background-color: #34495e;
            border-radius: 2px;
            margin-top: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--secondary-color);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .codec-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-top: 6px;
        }
        
        .codec-box {
            background-color: #2c3e50;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }
        
        .codec-name {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .codec-status {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            display: inline-block;
            color: white;
        }
        
        .supported {
            background-color: var(--success-color);
        }
        
        .unsupported {
            background-color: var(--danger-color);
        }
        
        .unknown {
            background-color: #7f8c8d;
            color: #ecf0f1;
        }
        
        .stream-type-badge {
            display: inline-block;
            padding: 1px 4px;
            border-radius: 8px;
            font-size: 8px;
            margin-left: 4px;
            background-color: var(--info-color);
            color: white;
        }

        .multi-stream-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 3px;
            margin: 6px 0;
            max-height: 80px;
            overflow-y: auto;
        }

        .selection-item {
            background: #2c3e50;
            padding: 3px;
            border-radius: 4px;
            font-size: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .selection-item.selected {
            background: var(--success-color);
            color: white;
        }

        .selection-item:hover {
            background: var(--secondary-color);
        }

        .file-controls {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }

        .file-controls .btn {
            flex: 1;
            padding: 5px 8px;
        }

        .hidden-file-input {
            display: none;
        }

        .channel-info {
            font-size: 10px;
            color: #aaa;
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .channel-url {
            word-break: break-all;
            max-height: 25px;
            overflow: hidden;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .control-panel {
                max-height: 400px;
            }
            
            .video-player {
                min-height: 300px;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 6px;
            }
            
            .main-content {
                gap: 8px;
            }
            
            .control-panel {
                padding: 8px;
            }
            
            .stats-container, .codec-info {
                grid-template-columns: 1fr;
            }
            
            .video-controls {
                padding: 8px;
                flex-direction: column;
                gap: 6px;
            }
            
            .control-group {
                width: 100%;
                justify-content: center;
            }
            
            .volume-control {
                width: 100%;
                justify-content: center;
            }
            
            .fit-to-page-btn {
                right: 70px;
            }

            .multi-stream-container {
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(5, 1fr);
            }

            .multi-stream-layout-controls {
                top: 8px;
                left: 8px;
                max-width: 180px;
            }

            .layout-btn {
                padding: 5px 8px;
                font-size: 9px;
            }

            .file-controls {
                flex-direction: column;
            }
            
            /* MODIFICHE: Layout verticale per schermi piccoli */
            .analysis-container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 1fr;
            }
            
            .debug-panel {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="control-panel">
                <div class="form-group">
                    <label for="stream-url">URL del Feed Streaming</label>
                    <input type="text" id="stream-url" placeholder="Inserisci l'URL del feed streaming">
                </div>
                
                <div class="form-group">
                    <label for="stream-type">Tipo Stream</label>
                    <select id="stream-type">
                        <option value="auto">Rilevamento Automatico</option>
                        <option value="hls">HLS (.m3u8)</option>
                        <option value="mp4">MP4 Direct</option>
                        <option value="webm">WebM Direct</option>
                    </select>
                </div>
                
                <!-- Codec Info -->
                <div class="codec-info">
                    <div class="codec-box">
                        <div class="codec-name">Codec Video</div>
                        <span id="video-codec-status" class="codec-status unknown">Analizza per rilevare</span>
                    </div>
                    <div class="codec-box">
                        <div class="codec-name">Codec Audio</div>
                        <span id="audio-codec-status" class="codec-status unknown">Analizza per rilevare</span>
                    </div>
                </div>
                
                <div class="control-group">
                    <button id="play-btn" class="btn btn-success">Play</button>
                    <button id="stop-btn" class="btn btn-danger">Stop</button>
                    <button id="analyze-btn" class="btn btn-info">Analizza</button>
                </div>

                <!-- Stats Container -->
                <div class="stats-container">
                    <div class="stat-box">
                        <div class="stat-label">Risoluzione</div>
                        <div class="stat-value" id="video-resolution">0x0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Bitrate Video</div>
                        <div class="stat-value" id="video-bitrate">0 kbps</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="video-bitrate-bar"></div>
                        </div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Bitrate Audio</div>
                        <div class="stat-value" id="audio-bitrate">0 kbps</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="audio-bitrate-bar"></div>
                        </div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Buffer</div>
                        <div class="stat-value" id="buffer-level">0s</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="buffer-bar"></div>
                        </div>
                    </div>
                </div>

                <h3 class="section-title">Selezione Multi-Stream (Max 9 Canali)</h3>
                <div class="form-group">
                    <div style="font-size: 10px; color: #aaa; margin-bottom: 6px;">
                        Seleziona fino a 9 canali per la visualizzazione simultanea
                    </div>
                    <div id="selected-channels" class="multi-stream-selection">
                        <!-- Canali selezionati appariranno qui -->
                    </div>
                    <button id="start-multi-stream" class="btn btn-multi" style="width: 100%; margin-top: 6px;" disabled>
                        Avvia Multi-Stream (0/9)
                    </button>
                </div>
                
                <h3 class="section-title">Gestione Lista Canali</h3>
                <div class="form-group">
                    <input type="text" id="channel-name" placeholder="Nome canale">
                    <button id="add-channel" class="btn btn-primary" style="margin-top: 6px; width: 100%;">Aggiungi alla Lista</button>
                </div>
                
                <div class="file-controls">
                    <button id="save-channels" class="btn btn-success">Salva Lista</button>
                    <button id="load-channels" class="btn btn-warning">Carica Lista</button>
                    <input type="file" id="file-input" class="hidden-file-input" accept=".txt">
                </div>
                
                <div class="channel-list-container">
                    <h3 class="section-title">Lista Canali Salvati</h3>
                    <div class="channel-list" id="channel-list">
                        <!-- I canali verranno aggiunti qui dinamicamente -->
                    </div>
                </div>
                
                <h3 class="section-title">Ricerca Canali</h3>
                <div class="form-group">
                    <input type="text" id="search-channels" placeholder="Cerca nei canali salvati">
                </div>
            </div>
            
            <div class="video-container">
                <button id="fit-to-page-btn" class="fit-to-page-btn" title="Adatta alla pagina">Fit to Page</button>
                <button id="fullscreen-btn" class="fullscreen-btn" title="Schermo intero">Schermo Intero</button>
                <video id="video-player" class="video-player" controls crossorigin="anonymous"></video>
                <div class="video-controls">
                    <div class="control-group">
                        <button id="video-play" class="btn btn-primary">Play</button>
                        <button id="video-pause" class="btn btn-warning">Pausa</button>
                        <button id="video-stop" class="btn btn-danger">Stop</button>
                    </div>
                    <div class="volume-control">
                        <span>ðŸ”Š</span>
                        <input type="range" id="volume-slider" class="volume-slider" min="0" max="100" value="50">
                    </div>
                </div>
                
                <!-- MODIFICHE: Aggiunto container per log e grafici affiancati -->
                <div class="debug-panel">
                    <h3>Analisi Stream in Tempo Reale</h3>
                    <div class="analysis-container">
                        <div class="log-container">
                            <div class="log-title">Log di Sistema</div>
                            <div class="debug-info" id="debug-info">
                                Sistema inizializzato. Inserisci un URL per iniziare l'analisi.
                            </div>
                        </div>
                        <div class="graphs-container">
                            <div class="graph-container">
                                <div class="graph-title">Bitrate Video</div>
                                <!-- MODIFICHE: Aggiunto valore numerico live -->
                                <div class="graph-value bitrate" id="bitrate-value">0 kbps</div>
                                <div class="graph-canvas">
                                    <div class="graph-grid"></div>
                                    <div class="graph" id="video-bitrate-graph">
                                        <div class="graph-line bitrate" id="video-bitrate-line"></div>
                                    </div>
                                </div>
                                <div class="graph-labels">
                                    <span>0</span>
                                    <span>30s</span>
                                    <span>60s</span>
                                </div>
                            </div>
                            <div class="graph-container">
                                <div class="graph-title">QualitÃ  Stream</div>
                                <!-- MODIFICHE: Aggiunto valore numerico live -->
                                <div class="graph-value quality" id="quality-value">0%</div>
                                <div class="graph-canvas">
                                    <div class="graph-grid"></div>
                                    <div class="graph" id="quality-graph">
                                        <div class="graph-line quality" id="quality-line"></div>
                                    </div>
                                </div>
                                <div class="graph-labels">
                                    <span>0</span>
                                    <span>30s</span>
                                    <span>60s</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="graph-legend">
                        <div class="legend-item">
                            <div class="legend-color bitrate"></div>
                            <span>Bitrate</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color buffer"></div>
                            <span>Buffer</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color quality"></div>
                            <span>QualitÃ </span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color network"></div>
                            <span>Network</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Multi-Stream Container 9 Canali -->
    <div class="multi-stream-container" id="multi-stream-container">
        <button class="exit-multi-stream" id="exit-multi-stream">Esci Multi-Stream</button>
        <div class="multi-stream-layout-controls">
            <button class="layout-btn active" data-layout="3x3">3Ã—3</button>
            <button class="layout-btn" data-layout="2x2">2Ã—2</button>
            <button class="layout-btn" data-layout="1x1">1Ã—1</button>
            <button class="layout-btn" data-layout="fit-all">Fit All</button>
            <button class="layout-btn" data-layout="mute-all">Muta Tutti</button>
        </div>
        <!-- I 9 video verranno aggiunti qui dinamicamente -->
    </div>

    <!-- Includiamo HLS.js per supportare stream HLS -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementi DOM
            const videoPlayer = document.getElementById('video-player');
            const streamUrlInput = document.getElementById('stream-url');
            const streamTypeSelect = document.getElementById('stream-type');
            const playBtn = document.getElementById('play-btn');
            const stopBtn = document.getElementById('stop-btn');
            const analyzeBtn = document.getElementById('analyze-btn');
            const startMultiStreamBtn = document.getElementById('start-multi-stream');
            const videoPlayBtn = document.getElementById('video-play');
            const videoPauseBtn = document.getElementById('video-pause');
            const videoStopBtn = document.getElementById('video-stop');
            const volumeSlider = document.getElementById('volume-slider');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const fitToPageBtn = document.getElementById('fit-to-page-btn');
            const debugInfo = document.getElementById('debug-info');
            const addChannelBtn = document.getElementById('add-channel');
            const channelNameInput = document.getElementById('channel-name');
            const channelList = document.getElementById('channel-list');
            const searchChannelsInput = document.getElementById('search-channels');
            const selectedChannelsDiv = document.getElementById('selected-channels');
            const multiStreamContainer = document.getElementById('multi-stream-container');
            const exitMultiStreamBtn = document.getElementById('exit-multi-stream');
            const saveChannelsBtn = document.getElementById('save-channels');
            const loadChannelsBtn = document.getElementById('load-channels');
            const fileInput = document.getElementById('file-input');
            
            // Elementi per codec e statistiche
            const videoCodecStatus = document.getElementById('video-codec-status');
            const audioCodecStatus = document.getElementById('audio-codec-status');
            const videoBitrateEl = document.getElementById('video-bitrate');
            const audioBitrateEl = document.getElementById('audio-bitrate');
            const videoResolutionEl = document.getElementById('video-resolution');
            const bufferLevelEl = document.getElementById('buffer-level');
            const videoBitrateBar = document.getElementById('video-bitrate-bar');
            const audioBitrateBar = document.getElementById('audio-bitrate-bar');
            const bufferBar = document.getElementById('buffer-bar');
            
            // MODIFICHE: Elementi per i grafici e valori numerici
            const videoBitrateGraph = document.getElementById('video-bitrate-graph');
            const videoBitrateLine = document.getElementById('video-bitrate-line');
            const qualityGraph = document.getElementById('quality-graph');
            const qualityLine = document.getElementById('quality-line');
            const bitrateValue = document.getElementById('bitrate-value');
            const qualityValue = document.getElementById('quality-value');
            
            // Stato dell'applicazione
            let currentStreamUrl = '';
            let channels = JSON.parse(localStorage.getItem('streamingChannels')) || [];
            let statsInterval;
            let hlsPlayer = null;
            let currentStreamType = 'auto';
            let isFitToPage = false;
            let selectedChannels = [];
            let multiStreamHlsPlayers = [];
            let currentLayout = '3x3';
            
            // MODIFICHE: Dati per i grafici
            let videoBitrateData = [];
            let bufferLevelData = [];
            let qualityData = [];
            let networkData = [];
            let volumeData = [];
            let fpsData = [];
            const maxDataPoints = 60; // 60 secondi di dati
            
            // MODIFICHE: Statistiche avanzate
            let streamStats = {
                bitrateHistory: [],
                qualityHistory: [],
                bufferHistory: [],
                networkHistory: [],
                droppedFrames: 0,
                totalFrames: 0,
                startTime: null,
                lastUpdate: null
            };
            
            // Database di stream pubblici funzionanti
            const publicStreams = [
                {
                    title: "NASA TV Public",
                    url: "https://ntv1.akamaized.net/hls/live/2014075/NASA-NTV1-Public/master.m3u8",
                    category: "news",
                    type: "hls",
                    country: "US",
                    language: "en",
                    quality: "HD"
                },
                {
                    title: "Deutsche Welle English",
                    url: "https://dwstream3-lh.akamaihd.net/i/dwstream3_live@124409/master.m3u8",
                    category: "news",
                    type: "hls",
                    country: "DE",
                    language: "en",
                    quality: "HD"
                },
                {
                    title: "France 24 English",
                    url: "https://f24hls-i.akamaihd.net/hls/live/221192/F24_EN_HI_HLS/master_2000.m3u8",
                    category: "news",
                    type: "hls",
                    country: "FR",
                    language: "en",
                    quality: "HD"
                }
            ];
            
            // Inizializzazione
            function init() {
                updateDebugInfo('Sistema inizializzato. Pronto per l\'analisi stream.');
                renderChannelList();
                setupEventListeners();
                checkMediaCapabilities();
                
                // Aggiorna display canali selezionati
                updateSelectedChannelsDisplay();
                
                // MODIFICHE: Inizializza i grafici
                initGraphs();
                
                // Aggiungi alcuni stream pubblici se la lista Ã¨ vuota
                if (channels.length === 0) {
                    publicStreams.forEach(stream => {
                        channels.push({
                            id: Date.now() + Math.random(),
                            name: stream.title,
                            url: stream.url,
                            type: stream.type,
                            dateAdded: new Date().toLocaleDateString()
                        });
                    });
                    saveChannels();
                    renderChannelList();
                }
            }
            
            // MODIFICHE: Inizializza i grafici
            function initGraphs() {
                // Pulisci i dati
                videoBitrateData = [];
                bufferLevelData = [];
                qualityData = [];
                networkData = [];
                volumeData = [];
                fpsData = [];
                
                // Resetta le linee dei grafici
                videoBitrateLine.style.height = '0%';
                qualityLine.style.height = '0%';
                
                // MODIFICHE: Resetta i valori numerici
                bitrateValue.textContent = '0 kbps';
                qualityValue.textContent = '0%';
                
                // Pulisci i punti esistenti
                document.querySelectorAll('.graph-point').forEach(point => point.remove());
                
                // MODIFICHE: Resetta statistiche
                streamStats = {
                    bitrateHistory: [],
                    qualityHistory: [],
                    bufferHistory: [],
                    networkHistory: [],
                    droppedFrames: 0,
                    totalFrames: 0,
                    startTime: null,
                    lastUpdate: null
                };
            }
            
            // MODIFICHE: Calcola qualitÃ  stream basata su bitrate e buffer
            function calculateStreamQuality(bitrate, bufferLevel, networkLatency = 0) {
                let qualityScore = 0;
                
                // Punteggio basato sul bitrate (0-50 punti)
                if (bitrate > 5000) qualityScore += 50;
                else if (bitrate > 2000) qualityScore += 40;
                else if (bitrate > 1000) qualityScore += 30;
                else if (bitrate > 500) qualityScore += 20;
                else if (bitrate > 100) qualityScore += 10;
                
                // Punteggio basato sul buffer (0-30 punti)
                if (bufferLevel > 20) qualityScore += 30;
                else if (bufferLevel > 10) qualityScore += 25;
                else if (bufferLevel > 5) qualityScore += 20;
                else if (bufferLevel > 2) qualityScore += 15;
                else if (bufferLevel > 0) qualityScore += 10;
                
                // Punteggio basato sulla latenza di rete (0-20 punti)
                if (networkLatency < 50) qualityScore += 20;
                else if (networkLatency < 100) qualityScore += 15;
                else if (networkLatency < 200) qualityScore += 10;
                else if (networkLatency < 500) qualityScore += 5;
                
                return Math.min(qualityScore, 100);
            }
            
            // MODIFICHE: Simula latenza di rete
            function simulateNetworkLatency() {
                return Math.random() * 200 + 50; // 50-250ms
            }
            
            // MODIFICHE: Aggiorna i grafici con nuovi dati
            function updateGraphs() {
                // Aggiorna grafico bitrate video
                if (videoBitrateData.length > 0) {
                    const maxBitrate = Math.max(...videoBitrateData.map(d => d.value), 5000);
                    const currentBitrate = videoBitrateData[videoBitrateData.length - 1].value;
                    const heightPercentage = Math.min((currentBitrate / maxBitrate) * 100, 100);
                    videoBitrateLine.style.height = `${heightPercentage}%`;
                    
                    // MODIFICHE: Aggiorna valore numerico
                    bitrateValue.textContent = `${currentBitrate} kbps`;
                    
                    // Aggiorna i punti del grafico
                    updateGraphPoints(videoBitrateGraph, videoBitrateData, maxBitrate, 'bitrate');
                }
                
                // Aggiorna grafico qualitÃ 
                if (qualityData.length > 0) {
                    const currentQuality = qualityData[qualityData.length - 1].value;
                    qualityLine.style.height = `${currentQuality}%`;
                    
                    // MODIFICHE: Aggiorna valore numerico
                    qualityValue.textContent = `${currentQuality}%`;
                    
                    // Aggiorna i punti del grafico
                    updateGraphPoints(qualityGraph, qualityData, 100, 'quality');
                }
            }
            
            // MODIFICHE: Aggiorna i punti sui grafici
            function updateGraphPoints(graphElement, data, maxValue, type) {
                // Rimuovi i punti esistenti
                graphElement.querySelectorAll('.graph-point').forEach(point => point.remove());
                
                // Aggiungi nuovi punti (solo gli ultimi 20 punti per performance)
                const recentData = data.slice(-20);
                recentData.forEach(point => {
                    const pointElement = document.createElement('div');
                    pointElement.className = `graph-point ${type}`;
                    
                    // Calcola la posizione X (basata sul tempo)
                    const timeDiff = Date.now() - point.timestamp;
                    const xPercentage = Math.max(0, 100 - (timeDiff / 60000) * 100); // 60 secondi di finestra
                    
                    // Calcola la posizione Y (basata sul valore)
                    const yPercentage = Math.min((point.value / maxValue) * 100, 100);
                    
                    pointElement.style.left = `${xPercentage}%`;
                    pointElement.style.bottom = `${yPercentage}%`;
                    
                    graphElement.appendChild(pointElement);
                });
            }
            
            // MODIFICHE: Aggiungi dati ai grafici
            function addGraphData(graphType, value) {
                const timestamp = Date.now();
                
                if (graphType === 'bitrate') {
                    videoBitrateData.push({ value, timestamp });
                    streamStats.bitrateHistory.push({ value, timestamp });
                    
                    // Mantieni solo gli ultimi maxDataPoints
                    if (videoBitrateData.length > maxDataPoints) {
                        videoBitrateData.shift();
                    }
                    if (streamStats.bitrateHistory.length > maxDataPoints) {
                        streamStats.bitrateHistory.shift();
                    }
                } else if (graphType === 'buffer') {
                    bufferLevelData.push({ value, timestamp });
                    streamStats.bufferHistory.push({ value, timestamp });
                    
                    // Mantieni solo gli ultimi maxDataPoints
                    if (bufferLevelData.length > maxDataPoints) {
                        bufferLevelData.shift();
                    }
                    if (streamStats.bufferHistory.length > maxDataPoints) {
                        streamStats.bufferHistory.shift();
                    }
                } else if (graphType === 'quality') {
                    qualityData.push({ value, timestamp });
                    streamStats.qualityHistory.push({ value, timestamp });
                    
                    // Mantieni solo gli ultimi maxDataPoints
                    if (qualityData.length > maxDataPoints) {
                        qualityData.shift();
                    }
                    if (streamStats.qualityHistory.length > maxDataPoints) {
                        streamStats.qualityHistory.shift();
                    }
                } else if (graphType === 'network') {
                    networkData.push({ value, timestamp });
                    streamStats.networkHistory.push({ value, timestamp });
                    
                    // Mantieni solo gli ultimi maxDataPoints
                    if (networkData.length > maxDataPoints) {
                        networkData.shift();
                    }
                    if (streamStats.networkHistory.length > maxDataPoints) {
                        streamStats.networkHistory.shift();
                    }
                }
                
                updateGraphs();
            }
            
            // MODIFICHE: Aggiorna statistiche avanzate
            function updateAdvancedStats() {
                if (videoBitrateData.length > 0 && bufferLevelData.length > 0) {
                    const currentBitrate = videoBitrateData[videoBitrateData.length - 1].value;
                    const currentBuffer = bufferLevelData[bufferLevelData.length - 1].value;
                    const networkLatency = simulateNetworkLatency();
                    
                    // Calcola qualitÃ  dello stream
                    const quality = calculateStreamQuality(currentBitrate, currentBuffer, networkLatency);
                    addGraphData('quality', quality);
                    
                    // Aggiorna statistiche di rete
                    addGraphData('network', networkLatency);
                    
                    // Aggiorna statistiche frame
                    streamStats.totalFrames++;
                    if (Math.random() < 0.02) { // Simula frame dropped
                        streamStats.droppedFrames++;
                    }
                    
                    streamStats.lastUpdate = Date.now();
                }
            }
            
            // Setup degli event listeners
            function setupEventListeners() {
                playBtn.addEventListener('click', playStream);
                stopBtn.addEventListener('click', stopStream);
                analyzeBtn.addEventListener('click', analyzeStream);
                startMultiStreamBtn.addEventListener('click', startMultiStream);
                exitMultiStreamBtn.addEventListener('click', exitMultiStream);
                videoPlayBtn.addEventListener('click', () => videoPlayer.play());
                videoPauseBtn.addEventListener('click', () => videoPlayer.pause());
                videoStopBtn.addEventListener('click', stopStream);
                volumeSlider.addEventListener('input', setVolume);
                fullscreenBtn.addEventListener('click', toggleFullscreen);
                fitToPageBtn.addEventListener('click', toggleFitToPage);
                addChannelBtn.addEventListener('click', addChannel);
                searchChannelsInput.addEventListener('input', searchChannels);
                streamTypeSelect.addEventListener('change', handleStreamTypeChange);
                saveChannelsBtn.addEventListener('click', saveChannelsToFile);
                loadChannelsBtn.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', loadChannelsFromFile);
                
                // Layout controls
                document.addEventListener('click', function(e) {
                    if (e.target.classList.contains('layout-btn')) {
                        const layout = e.target.dataset.layout;
                        changeLayout(layout, e.target);
                    }
                });
                
                // Eventi del video player
                videoPlayer.addEventListener('loadstart', handleLoadStart);
                videoPlayer.addEventListener('loadedmetadata', handleMetadataLoaded);
                videoPlayer.addEventListener('canplay', handleCanPlay);
                videoPlayer.addEventListener('playing', handlePlaying);
                videoPlayer.addEventListener('waiting', handleWaiting);
                videoPlayer.addEventListener('seeking', handleSeeking);
                videoPlayer.addEventListener('seeked', handleSeeked);
                videoPlayer.addEventListener('ended', handleEnded);
                videoPlayer.addEventListener('error', handleVideoError);
                videoPlayer.addEventListener('volumechange', updateVolumeDisplay);
                videoPlayer.addEventListener('progress', handleProgress);
                videoPlayer.addEventListener('timeupdate', handleTimeUpdate);
                
                // Imposta il volume iniziale
                videoPlayer.volume = volumeSlider.value / 100;
            }
            
            // Salva lista canali su file TXT
            function saveChannelsToFile() {
                if (channels.length === 0) {
                    updateDebugInfo('Nessun canale da salvare', 'warning');
                    return;
                }
                
                // Crea il contenuto del file
                let fileContent = "# Lista Canali Streaming\n";
                fileContent += "# Formato: Nome|URL|Tipo\n\n";
                
                channels.forEach(channel => {
                    fileContent += `${channel.name}|${channel.url}|${channel.type}\n`;
                });
                
                // Crea e scarica il file
                const blob = new Blob([fileContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'lista_canali_streaming.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                updateDebugInfo(`Lista canali salvata (${channels.length} canali)`);
            }
            
            // Carica lista canali da file TXT
            function loadChannelsFromFile(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const lines = content.split('\n');
                        const newChannels = [];
                        
                        lines.forEach(line => {
                            // Salta linee vuote e commenti
                            if (!line.trim() || line.startsWith('#')) return;
                            
                            const parts = line.split('|');
                            if (parts.length >= 3) {
                                const name = parts[0].trim();
                                const url = parts[1].trim();
                                const type = parts[2].trim();
                                
                                if (name && url) {
                                    newChannels.push({
                                        id: Date.now() + Math.random(),
                                        name: name,
                                        url: url,
                                        type: type,
                                        dateAdded: new Date().toLocaleDateString()
                                    });
                                }
                            }
                        });
                        
                        if (newChannels.length > 0) {
                            channels = newChannels;
                            saveChannels();
                            renderChannelList();
                            updateDebugInfo(`Caricati ${newChannels.length} canali dal file`);
                        } else {
                            updateDebugInfo('Nessun canale valido trovato nel file', 'warning');
                        }
                    } catch (error) {
                        updateDebugInfo(`Errore nel caricamento del file: ${error.message}`, 'error');
                    }
                    
                    // Reset del file input
                    fileInput.value = '';
                };
                
                reader.readAsText(file);
            }
            
            // Cambia layout multi-stream
            function changeLayout(layout, button) {
                document.querySelectorAll('.layout-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                currentLayout = layout;
                
                switch(layout) {
                    case '3x3':
                        multiStreamContainer.style.gridTemplateColumns = 'repeat(3, 1fr)';
                        multiStreamContainer.style.gridTemplateRows = 'repeat(3, 1fr)';
                        break;
                    case '2x2':
                        multiStreamContainer.style.gridTemplateColumns = 'repeat(2, 1fr)';
                        multiStreamContainer.style.gridTemplateRows = 'repeat(2, 1fr)';
                        break;
                    case '1x1':
                        multiStreamContainer.style.gridTemplateColumns = '1fr';
                        multiStreamContainer.style.gridTemplateRows = '1fr';
                        break;
                    case 'fit-all':
                        document.querySelectorAll('.multi-stream-item').forEach(item => {
                            item.classList.add('fit-to-screen');
                        });
                        break;
                    case 'mute-all':
                        document.querySelectorAll('.multi-stream-video').forEach(video => {
                            video.muted = true;
                        });
                        updateAudioIndicators();
                        break;
                }
                
                updateDebugInfo(`Layout multi-stream cambiato: ${layout}`);
            }
            
            // Seleziona/deseleziona canale per multi-stream
            function toggleChannelSelection(channel) {
                const index = selectedChannels.findIndex(c => c.id === channel.id);
                
                if (index === -1) {
                    if (selectedChannels.length < 9) {
                        selectedChannels.push(channel);
                        updateDebugInfo(`Canale "${channel.name}" aggiunto alla selezione multi-stream`);
                    } else {
                        updateDebugInfo('Massimo 9 canali consentiti per il multi-stream', 'warning');
                        return;
                    }
                } else {
                    selectedChannels.splice(index, 1);
                    updateDebugInfo(`Canale "${channel.name}" rimosso dalla selezione multi-stream`);
                }
                
                updateSelectedChannelsDisplay();
                renderChannelList();
            }
            
            // Aggiorna display canali selezionati
            function updateSelectedChannelsDisplay() {
                selectedChannelsDiv.innerHTML = '';
                
                if (selectedChannels.length === 0) {
                    selectedChannelsDiv.innerHTML = '<div style="color: #7f8c8d; text-align: center; grid-column: 1 / -1;">Nessun canale selezionato</div>';
                    startMultiStreamBtn.disabled = true;
                    startMultiStreamBtn.textContent = 'Avvia Multi-Stream (0/9)';
                    return;
                }
                
                selectedChannels.forEach((channel, index) => {
                    const channelEl = document.createElement('div');
                    channelEl.className = 'selection-item selected';
                    channelEl.textContent = channel.name;
                    channelEl.title = channel.name;
                    
                    channelEl.addEventListener('click', function(e) {
                        e.stopPropagation();
                        selectedChannels.splice(index, 1);
                        updateSelectedChannelsDisplay();
                        renderChannelList();
                        updateDebugInfo(`Canale rimosso dalla selezione multi-stream`);
                    });
                    
                    selectedChannelsDiv.appendChild(channelEl);
                });
                
                // Riempie gli slot vuoti
                const emptySlots = 9 - selectedChannels.length;
                for (let i = 0; i < emptySlots; i++) {
                    const emptyEl = document.createElement('div');
                    emptyEl.className = 'selection-item';
                    emptyEl.textContent = `Slot ${i + 1 + selectedChannels.length}`;
                    emptyEl.style.color = '#7f8c8d';
                    emptyEl.style.cursor = 'default';
                    selectedChannelsDiv.appendChild(emptyEl);
                }
                
                startMultiStreamBtn.disabled = selectedChannels.length === 0;
                startMultiStreamBtn.textContent = `Avvia Multi-Stream (${selectedChannels.length}/9)`;
            }
            
            // Avvia modalitÃ  multi-stream
            function startMultiStream() {
                if (selectedChannels.length === 0) {
                    updateDebugInfo('Seleziona almeno un canale per il multi-stream', 'warning');
                    return;
                }
                
                updateDebugInfo(`Avvio modalitÃ  Multi-Stream con ${selectedChannels.length} canali`);
                
                // Prepara il container multi-stream
                multiStreamContainer.innerHTML = '';
                multiStreamContainer.appendChild(exitMultiStreamBtn);
                
                // Ricrea i controlli layout
                const layoutControls = document.createElement('div');
                layoutControls.className = 'multi-stream-layout-controls';
                layoutControls.innerHTML = `
                    <button class="layout-btn active" data-layout="3x3">3Ã—3</button>
                    <button class="layout-btn" data-layout="2x2">2Ã—2</button>
                    <button class="layout-btn" data-layout="1x1">1Ã—1</button>
                    <button class="layout-btn" data-layout="fit-all">Fit All</button>
                    <button class="layout-btn" data-layout="mute-all">Muta Tutti</button>
                `;
                multiStreamContainer.appendChild(layoutControls);
                
                // Crea i video elements per ogni canale
                selectedChannels.forEach((channel, index) => {
                    const streamItem = document.createElement('div');
                    streamItem.className = 'multi-stream-item';
                    streamItem.innerHTML = `
                        <div class="multi-stream-overlay">${channel.name}</div>
                        <div class="stream-status status-buffering">BUFFERING</div>
                        <div class="stream-audio-indicator audio-off">MUTO</div>
                        <video class="multi-stream-video" id="multi-video-${index}" muted></video>
                        <div class="multi-stream-controls">
                            <button class="multi-stream-btn" data-action="play">â–¶</button>
                            <button class="multi-stream-btn" data-action="pause">â¸</button>
                            <button class="multi-stream-btn" data-action="volume">ðŸ”‡</button>
                            <button class="multi-stream-btn" data-action="fit">ðŸ“</button>
                            <button class="multi-stream-btn warning" data-action="restart">ðŸ”„</button>
                        </div>
                    `;
                    
                    multiStreamContainer.appendChild(streamItem);
                    
                    // Setup controlli per ogni video
                    setupStreamControls(streamItem, index, channel);
                });
                
                // Mostra il container multi-stream
                multiStreamContainer.style.display = 'grid';
                document.body.style.overflow = 'hidden';
                
                // Avvia tutti gli stream
                startAllMultiStreams();
            }
            
            // Setup controlli per ogni stream
            function setupStreamControls(streamItem, index, channel) {
                const video = streamItem.querySelector('video');
                const controls = streamItem.querySelector('.multi-stream-controls');
                const statusIndicator = streamItem.querySelector('.stream-status');
                const audioIndicator = streamItem.querySelector('.stream-audio-indicator');
                
                // Play/Pause
                controls.querySelector('[data-action="play"]').addEventListener('click', () => {
                    video.play();
                    statusIndicator.textContent = 'LIVE';
                    statusIndicator.className = 'stream-status status-live';
                });
                
                controls.querySelector('[data-action="pause"]').addEventListener('click', () => {
                    video.pause();
                    statusIndicator.textContent = 'PAUSA';
                    statusIndicator.className = 'stream-status status-buffering';
                });
                
                // Volume
                controls.querySelector('[data-action="volume"]').addEventListener('click', function() {
                    video.muted = !video.muted;
                    this.textContent = video.muted ? 'ðŸ”‡' : 'ðŸ”Š';
                    audioIndicator.textContent = video.muted ? 'MUTO' : 'AUDIO';
                    audioIndicator.className = `stream-audio-indicator ${video.muted ? 'audio-off' : 'audio-on'}`;
                });
                
                // Fit to screen
                controls.querySelector('[data-action="fit"]').addEventListener('click', function() {
                    streamItem.classList.toggle('fit-to-screen');
                    this.classList.toggle('active');
                    this.textContent = streamItem.classList.contains('fit-to-screen') ? 'ðŸ“' : 'ðŸ“';
                });
                
                // Restart stream
                controls.querySelector('[data-action="restart"]').addEventListener('click', () => {
                    restartStream(index, channel, video, statusIndicator);
                });
                
                // Eventi video per aggiornare lo status
                video.addEventListener('playing', () => {
                    statusIndicator.textContent = 'LIVE';
                    statusIndicator.className = 'stream-status status-live';
                });
                
                video.addEventListener('waiting', () => {
                    statusIndicator.textContent = 'BUFFERING';
                    statusIndicator.className = 'stream-status status-buffering';
                });
                
                video.addEventListener('error', () => {
                    statusIndicator.textContent = 'ERROR';
                    statusIndicator.className = 'stream-status status-error';
                });
            }
            
            // Riavvia uno stream
            function restartStream(index, channel, video, statusIndicator) {
                statusIndicator.textContent = 'RIAVVIO';
                statusIndicator.className = 'stream-status status-buffering';
                
                // Ferma il player HLS esistente
                if (multiStreamHlsPlayers[index]) {
                    multiStreamHlsPlayers[index].destroy();
                }
                
                // Riproduci di nuovo
                setTimeout(() => {
                    if (channel.type === 'hls' && Hls.isSupported()) {
                        const hls = new Hls({
                            enableWorker: false,
                            lowLatencyMode: true,
                            backBufferLength: 90
                        });
                        
                        hls.loadSource(channel.url);
                        hls.attachMedia(video);
                        
                        hls.on(Hls.Events.MANIFEST_PARSED, function() {
                            video.play().catch(console.error);
                        });
                        
                        multiStreamHlsPlayers[index] = hls;
                    } else {
                        video.src = channel.url;
                        video.play().catch(console.error);
                    }
                }, 500);
            }
            
            // Aggiorna indicatori audio
            function updateAudioIndicators() {
                document.querySelectorAll('.multi-stream-video').forEach((video, index) => {
                    const audioIndicator = document.querySelector(`#multi-video-${index}`).closest('.multi-stream-item').querySelector('.stream-audio-indicator');
                    const volumeBtn = document.querySelector(`#multi-video-${index}`).closest('.multi-stream-item').querySelector('[data-action="volume"]');
                    
                    if (audioIndicator && volumeBtn) {
                        audioIndicator.textContent = video.muted ? 'MUTO' : 'AUDIO';
                        audioIndicator.className = `stream-audio-indicator ${video.muted ? 'audio-off' : 'audio-on'}`;
                        volumeBtn.textContent = video.muted ? 'ðŸ”‡' : 'ðŸ”Š';
                    }
                });
            }
            
            // Avvia tutti gli stream multi
            function startAllMultiStreams() {
                // Ferma eventuali player HLS precedenti
                multiStreamHlsPlayers.forEach(player => {
                    if (player) player.destroy();
                });
                multiStreamHlsPlayers = [];
                
                selectedChannels.forEach((channel, index) => {
                    const videoElement = document.getElementById(`multi-video-${index}`);
                    
                    if (!videoElement) return;
                    
                    if (channel.type === 'hls' && Hls.isSupported()) {
                        const hls = new Hls({
                            enableWorker: false,
                            lowLatencyMode: true,
                            backBufferLength: 90
                        });
                        
                        hls.loadSource(channel.url);
                        hls.attachMedia(videoElement);
                        
                        hls.on(Hls.Events.MANIFEST_PARSED, function() {
                            videoElement.play().catch(e => {
                                console.log(`Errore riproduzione canale ${index}:`, e);
                            });
                        });
                        
                        hls.on(Hls.Events.ERROR, function(event, data) {
                            if (data.fatal) {
                                console.log(`Errore HLS canale ${index}:`, data.details);
                            }
                        });
                        
                        multiStreamHlsPlayers.push(hls);
                    } else {
                        // Stream diretto
                        videoElement.src = channel.url;
                        videoElement.play().catch(e => {
                            console.log(`Errore riproduzione canale ${index}:`, e);
                        });
                        multiStreamHlsPlayers.push(null);
                    }
                });
                
                updateDebugInfo(`Multi-Stream avviato con ${selectedChannels.length} stream`);
            }
            
            // Esci dalla modalitÃ  multi-stream
            function exitMultiStream() {
                // Ferma tutti i player HLS
                multiStreamHlsPlayers.forEach(player => {
                    if (player) player.destroy();
                });
                multiStreamHlsPlayers = [];
                
                // Nascondi il container multi-stream
                multiStreamContainer.style.display = 'none';
                document.body.style.overflow = 'auto';
                
                updateDebugInfo('ModalitÃ  Multi-Stream terminata');
            }
            
            // Gestione cambio tipo stream
            function handleStreamTypeChange() {
                currentStreamType = streamTypeSelect.value;
                updateDebugInfo(`Tipo stream impostato su: ${currentStreamType}`);
            }
            
            // Riproduci lo stream
            function playStream() {
                const url = streamUrlInput.value.trim();
                if (!url) {
                    updateDebugInfo('Errore: Inserisci un URL valido', 'error');
                    return;
                }
                
                currentStreamUrl = url;
                stopStream(); // Ferma stream precedente
                
                // MODIFICHE: Inizializza i grafici
                initGraphs();
                
                // Determina il tipo di stream
                const streamType = detectStreamType(url);
                updateDebugInfo(`Tipo stream rilevato: ${streamType}`);
                
                if (streamType === 'hls' && Hls.isSupported()) {
                    playHlsStream(url);
                } else {
                    playDirectStream(url);
                }
            }
            
            // Rileva il tipo di stream dall'URL
            function detectStreamType(url) {
                if (currentStreamType !== 'auto') {
                    return currentStreamType;
                }
                
                const urlLower = url.toLowerCase();
                if (urlLower.includes('.m3u8')) return 'hls';
                if (urlLower.includes('.mp4')) return 'mp4';
                if (urlLower.includes('.webm')) return 'webm';
                return 'direct';
            }
            
            // Riproduci stream HLS
            function playHlsStream(url) {
                if (hlsPlayer) {
                    hlsPlayer.destroy();
                }
                
                hlsPlayer = new Hls({
                    enableWorker: false,
                    lowLatencyMode: true,
                    backBufferLength: 90
                });
                
                hlsPlayer.loadSource(url);
                hlsPlayer.attachMedia(videoPlayer);
                
                hlsPlayer.on(Hls.Events.MANIFEST_PARSED, function() {
                    updateDebugInfo('Manifest HLS parsato. Avvio riproduzione...');
                    videoPlayer.play().catch(e => {
                        updateDebugInfo(`Errore riproduzione: ${e.message}`, 'error');
                    });
                });
                
                hlsPlayer.on(Hls.Events.ERROR, function(event, data) {
                    if (data.fatal) {
                        updateDebugInfo(`Errore HLS: ${data.details}`, 'error');
                    }
                });
            }
            
            // Riproduci stream diretto
            function playDirectStream(url) {
                videoPlayer.src = url;
                videoPlayer.load();
                
                videoPlayer.play().then(() => {
                    updateDebugInfo('Riproduzione avviata con successo');
                }).catch(error => {
                    updateDebugInfo(`Errore durante la riproduzione: ${error.message}`, 'error');
                });
            }
            
            // Analizza lo stream
            function analyzeStream() {
                if (!videoPlayer.src && !currentStreamUrl) {
                    updateDebugInfo('Errore: Avvia prima uno stream per analizzarlo', 'error');
                    return;
                }
                
                updateDebugInfo('Analisi stream in corso...');
                
                analyzeVideoCapabilities();
                analyzeCodecs();
                
                // MODIFICHE: Mostra statistiche avanzate
                if (streamStats.bitrateHistory.length > 0) {
                    const avgBitrate = Math.round(streamStats.bitrateHistory.reduce((a, b) => a + b.value, 0) / streamStats.bitrateHistory.length);
                    const avgQuality = Math.round(streamStats.qualityHistory.reduce((a, b) => a + b.value, 0) / streamStats.qualityHistory.length);
                    const frameDropRate = streamStats.totalFrames > 0 ? (streamStats.droppedFrames / streamStats.totalFrames * 100).toFixed(2) : 0;
                    
                    updateDebugInfo(`Statistiche avanzate:`);
                    updateDebugInfo(`  Bitrate medio: ${avgBitrate} kbps`);
                    updateDebugInfo(`  QualitÃ  media: ${avgQuality}%`);
                    updateDebugInfo(`  Frame drop rate: ${frameDropRate}%`);
                    updateDebugInfo(`  Frame totali: ${streamStats.totalFrames}`);
                }
            }
            
            // Analizza le capacitÃ  video
            function analyzeVideoCapabilities() {
                if (!videoPlayer.videoWidth) {
                    updateDebugInfo('Impossibile analizzare: video non caricato', 'warning');
                    return;
                }
                
                const width = videoPlayer.videoWidth;
                const height = videoPlayer.videoHeight;
                const aspectRatio = (width / height).toFixed(2);
                
                updateDebugInfo(`Risoluzione: ${width}x${height} (${aspectRatio}:1)`);
                updateDebugInfo(`Durata: ${formatTime(videoPlayer.duration)}`);
                
                videoResolutionEl.textContent = `${width}x${height}`;
            }
            
            // Analizza i codec
            function analyzeCodecs() {
                if (videoPlayer.canPlayType) {
                    const videoCodecs = [
                        { codec: 'H.264', type: 'video/mp4; codecs="avc1.42E01E"' },
                        { codec: 'VP9', type: 'video/webm; codecs="vp9"' }
                    ];
                    
                    const audioCodecs = [
                        { codec: 'AAC', type: 'audio/mp4; codecs="mp4a.40.2"' },
                        { codec: 'MP3', type: 'audio/mpeg; codecs="mp3"' }
                    ];
                    
                    let videoDetected = false;
                    let audioDetected = false;
                    
                    videoCodecs.forEach(item => {
                        const canPlay = videoPlayer.canPlayType(item.type);
                        if (canPlay && !videoDetected) {
                            videoCodecStatus.textContent = item.codec;
                            videoCodecStatus.className = 'codec-status supported';
                            videoDetected = true;
                        }
                    });
                    
                    audioCodecs.forEach(item => {
                        const canPlay = videoPlayer.canPlayType(item.type);
                        if (canPlay && !audioDetected) {
                            audioCodecStatus.textContent = item.codec;
                            audioCodecStatus.className = 'codec-status supported';
                            audioDetected = true;
                        }
                    });
                }
            }
            
            // Attiva/disattiva fit to page
            function toggleFitToPage() {
                isFitToPage = !isFitToPage;
                
                if (isFitToPage) {
                    videoPlayer.classList.add('fit-to-page');
                    fitToPageBtn.classList.add('active');
                    fitToPageBtn.textContent = 'Fit to Page âœ“';
                    updateDebugInfo('ModalitÃ  Fit to Page attivata');
                } else {
                    videoPlayer.classList.remove('fit-to-page');
                    fitToPageBtn.classList.remove('active');
                    fitToPageBtn.textContent = 'Fit to Page';
                    updateDebugInfo('ModalitÃ  Fit to Page disattivata');
                }
            }
            
            // Ferma lo stream
            function stopStream() {
                if (hlsPlayer) {
                    hlsPlayer.destroy();
                    hlsPlayer = null;
                }
                
                videoPlayer.pause();
                videoPlayer.src = '';
                videoPlayer.load();
                
                updateDebugInfo('Stream fermato');
                stopStatsCollection();
                resetStats();
                
                // MODIFICHE: Resetta i grafici
                initGraphs();
                
                // Reset codec display
                videoCodecStatus.textContent = 'Analizza per rilevare';
                videoCodecStatus.className = 'codec-status unknown';
                audioCodecStatus.textContent = 'Analizza per rilevare';
                audioCodecStatus.className = 'codec-status unknown';
            }
            
            // Controlla le capacitÃ  multimediali del browser
            function checkMediaCapabilities() {
                updateDebugInfo('Browser capabilities:');
                updateDebugInfo(`  HLS supportato: ${Hls.isSupported() ? 'SÃ¬' : 'No'}`);
                updateDebugInfo(`  MediaSource API: ${!!window.MediaSource ? 'SÃ¬' : 'No'}`);
            }
            
            // Gestione eventi video
            function handleLoadStart() {
                updateDebugInfo('Caricamento stream iniziato...', 'info');
            }
            
            function handleMetadataLoaded() {
                const width = videoPlayer.videoWidth;
                const height = videoPlayer.videoHeight;
                videoResolutionEl.textContent = `${width}x${height}`;
                
                updateDebugInfo(`Metadati caricati: ${width}x${height}`, 'info');
                startStatsCollection();
            }
            
            function handleCanPlay() {
                updateDebugInfo('Stream pronto per la riproduzione', 'info');
            }
            
            function handlePlaying() {
                updateDebugInfo('Riproduzione avviata', 'info');
                streamStats.startTime = Date.now();
            }
            
            function handleWaiting() {
                updateDebugInfo('Buffering...', 'warning');
            }
            
            function handleSeeking() {
                updateDebugInfo('Seek in corso...', 'info');
            }
            
            function handleSeeked() {
                updateDebugInfo('Seek completato', 'info');
            }
            
            function handleEnded() {
                updateDebugInfo('Stream terminato', 'info');
                stopStatsCollection();
            }
            
            function handleProgress() {
                if (videoPlayer.buffered.length > 0) {
                    const bufferedEnd = videoPlayer.buffered.end(videoPlayer.buffered.length - 1);
                    const currentTime = videoPlayer.currentTime;
                    const bufferedTime = bufferedEnd - currentTime;
                    
                    bufferLevelEl.textContent = `${bufferedTime.toFixed(1)}s`;
                    bufferBar.style.width = Math.min((bufferedTime / 30) * 100, 100) + '%';
                    
                    // MODIFICHE: Aggiorna grafico buffer
                    addGraphData('buffer', bufferedTime);
                }
            }
            
            function handleTimeUpdate() {
                updateBitrateInfo();
            }
            
            // Gestione errori video
            function handleVideoError(e) {
                let message = 'Errore sconosciuto nel video';
                
                switch(videoPlayer.error?.code) {
                    case 1:
                        message = 'ERRORE: Interruzione acquisizione';
                        break;
                    case 2:
                        message = 'ERRORE: Decodifica impossibile';
                        break;
                    case 3:
                        message = 'ERRORE: Formato non supportato';
                        break;
                    case 4:
                        message = 'ERRORE: Codec non supportato';
                        break;
                }
                
                updateDebugInfo(`${message}`, 'error');
            }
            
            // Aggiorna informazioni sul bitrate
            function updateBitrateInfo() {
                if (hlsPlayer && hlsPlayer.levels && hlsPlayer.currentLevel !== -1) {
                    const level = hlsPlayer.levels[hlsPlayer.currentLevel];
                    if (level && level.bitrate) {
                        const bitrate = Math.round(level.bitrate / 1000);
                        videoBitrateEl.textContent = `${bitrate} kbps`;
                        videoBitrateBar.style.width = Math.min(bitrate / 10000 * 100, 100) + '%';
                        
                        // MODIFICHE: Aggiorna grafico bitrate
                        addGraphData('bitrate', bitrate);
                        
                        // MODIFICHE: Aggiorna statistiche avanzate
                        updateAdvancedStats();
                    }
                }
            }
            
            // Avvia la raccolta delle statistiche
            function startStatsCollection() {
                stopStatsCollection();
                
                statsInterval = setInterval(() => {
                    updateBitrateInfo();
                }, 1000);
            }
            
            // Ferma la raccolta delle statistiche
            function stopStatsCollection() {
                if (statsInterval) {
                    clearInterval(statsInterval);
                }
            }
            
            // Resetta le statistiche
            function resetStats() {
                videoBitrateEl.textContent = '0 kbps';
                audioBitrateEl.textContent = '0 kbps';
                videoResolutionEl.textContent = '0x0';
                bufferLevelEl.textContent = '0s';
                
                videoBitrateBar.style.width = '0%';
                audioBitrateBar.style.width = '0%';
                bufferBar.style.width = '0%';
            }
            
            // Imposta il volume
            function setVolume() {
                videoPlayer.volume = volumeSlider.value / 100;
            }
            
            // Aggiorna la visualizzazione del volume
            function updateVolumeDisplay() {
                volumeSlider.value = videoPlayer.volume * 100;
            }
            
            // Attiva/disattiva schermo intero
            function toggleFullscreen() {
                if (!document.fullscreenElement) {
                    videoPlayer.requestFullscreen().catch(err => {
                        updateDebugInfo(`Errore schermo intero: ${err.message}`, 'error');
                    });
                } else {
                    document.exitFullscreen();
                }
            }
            
            // Aggiungi un canale alla lista
            function addChannel() {
                const name = channelNameInput.value.trim();
                const url = streamUrlInput.value.trim();
                
                if (!name || !url) {
                    updateDebugInfo('Errore: Inserisci sia nome che URL del canale', 'error');
                    return;
                }
                
                const streamType = detectStreamType(url);
                
                const channel = {
                    id: Date.now(),
                    name: name,
                    url: url,
                    type: streamType,
                    dateAdded: new Date().toLocaleDateString()
                };
                
                channels.push(channel);
                saveChannels();
                renderChannelList();
                
                channelNameInput.value = '';
                updateDebugInfo(`Canale "${name}" aggiunto alla lista`);
            }
            
            // Salva i canali nel localStorage
            function saveChannels() {
                localStorage.setItem('streamingChannels', JSON.stringify(channels));
            }
            
            // Renderizza la lista dei canali
            function renderChannelList(filteredChannels = null) {
                const channelsToRender = filteredChannels || channels;
                
                channelList.innerHTML = '';
                
                if (channelsToRender.length === 0) {
                    channelList.innerHTML = '<div class="channel-item">Nessun canale salvato</div>';
                    return;
                }
                
                channelsToRender.forEach(channel => {
                    const channelElement = document.createElement('div');
                    channelElement.className = 'channel-item';
                    
                    const isSelected = selectedChannels.some(c => c.id === channel.id);
                    if (isSelected) {
                        channelElement.classList.add('selected');
                    }
                    
                    channelElement.innerHTML = `
                        <div>
                            <div style="font-weight: bold;">${channel.name}</div>
                            <div class="channel-info">
                                ${channel.type.toUpperCase()}
                                <span class="stream-type-badge">${channel.type}</span>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-primary btn-small" data-id="${channel.id}">Carica</button>
                            <button class="btn ${isSelected ? 'btn-danger' : 'btn-success'} btn-small" data-id="${channel.id}" data-action="select">
                                ${isSelected ? 'âœ•' : '+'}
                            </button>
                        </div>
                    `;
                    
                    channelElement.querySelector('[data-id].btn-primary').addEventListener('click', () => {
                        loadChannel(channel);
                    });
                    
                    channelElement.querySelector('[data-action="select"]').addEventListener('click', function(e) {
                        e.stopPropagation();
                        toggleChannelSelection(channel);
                    });
                    
                    channelList.appendChild(channelElement);
                });
            }
            
            // Carica un canale
            function loadChannel(channel) {
                streamUrlInput.value = channel.url;
                streamTypeSelect.value = channel.type;
                currentStreamType = channel.type;
                
                updateDebugInfo(`Canale "${channel.name}" caricato. Clicca Play per avviare.`);
            }
            
            // Cerca nei canali
            function searchChannels() {
                const searchTerm = searchChannelsInput.value.toLowerCase();
                
                if (!searchTerm) {
                    renderChannelList();
                    return;
                }
                
                const filteredChannels = channels.filter(channel => 
                    channel.name.toLowerCase().includes(searchTerm) || 
                    channel.url.toLowerCase().includes(searchTerm)
                );
                
                renderChannelList(filteredChannels);
            }
            
            // Formatta il tempo in minuti:secondi
            function formatTime(seconds) {
                if (!seconds || !isFinite(seconds)) return '0:00';
                
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }
            
            // Aggiorna il pannello di debug
            function updateDebugInfo(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                let indicator = '';
                
                if (type === 'error') {
                    indicator = '<span class="status-indicator status-error"></span>';
                } else if (type === 'warning') {
                    indicator = '<span class="status-indicator status-warning"></span>';
                } else {
                    indicator = '<span class="status-indicator status-info"></span>';
                }
                
                const newEntry = document.createElement('div');
                newEntry.innerHTML = `${indicator} [${timestamp}] ${message}`;
                
                debugInfo.appendChild(newEntry);
                debugInfo.scrollTop = debugInfo.scrollHeight;
                
                // Mantieni solo le ultime 15 righe
                while (debugInfo.children.length > 15) {
                    debugInfo.removeChild(debugInfo.firstChild);
                }
            }
            
            // Inizializza l'applicazione
            init();
        });
    </script>
</body>
</html>
